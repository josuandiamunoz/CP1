pipeline {
    agent any

     stages {
	 
		stage('Get Code') {
            steps {
                git 'https://github.com/josuandiamunoz/CP1.git'
            }
        }
        
        stage('Unit') {
			steps {
				catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
					bat '''
						set PYTHONPATH=%WORKSPACE%
						coverage run --branch --source=app --omit=app\\__init__.py,app\\api.py -m pytest test\\unit
						coverage xml -o coverage-unit.xml

					'''
				}
				junit 'result-unit.xml'
			}
		}
		
				
		stage('Rest') {
			steps {
				catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
					bat '''
						set FLASK_APP=app\\api.py
						start flask run
						start java -jar C:\\Users\\josu\\Desktop\\unir\\wiremock-standalone-3.13.2.jar --port 9090 --verbose --root-dir test\\wiremock
						set PYTHONPATH=%WORKSPACE%
						pytest --junitxml=result-rest.xml test\\rest		
					'''
				}
				junit 'result-rest.xml'
			}
		} 
		stage ('Static'){
            steps{
                bat '''
                    flake8 --exit-zero --format=pylint app >flake8.out
                '''
                recordIssues tools: [flake8(pattern: 'flake8.out')], qualityGates: [[threshold: 8.0, type: 'TOTAL', unstable: true], [threshold: 10.0, type: 'TOTAL', unstable: false]]
            }
        }
		
		stage ('Coverage') {
			steps {
				recordCoverage qualityGates: [[criticality: 'NOTE', integerThreshold: 95, metric: 'LINE', threshold: 95.0],
											  [criticality: 'ERROR', integerThreshold: 85, metric: 'LINE', threshold: 85.0], 
											  [criticality: 'NOTE', integerThreshold: 90, metric: 'BRANCH', threshold: 90.0], 
											  [criticality: 'ERROR', integerThreshold: 80, metric: 'BRANCH', threshold: 80.0]],
				tools: [[parser: 'COBERTURA', pattern: 'coverage-unit.xml']]
			}
		}
		
		stage('Test') {
            steps {
                bat 'dir'
            }
        }
     }
}
