pipeline {
    agent any

     stages {
	 
		stage('Get Code') {
            steps {
                git 'https://github.com/josuandiamunoz/CP1.git'
            }
        }
        
        stage('Unit') {
			steps {
				catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
					bat '''
						set PYTHONPATH=%WORKSPACE%
						pytest --cov=app --cov-report=xml:coverage-unit.xml --junitxml=result-unit.xml test\\unit
					'''
				}
				junit 'result-unit.xml'
			}
		}
		
				
		stage('Rest') {
			steps {
				catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
					bat '''
						set FLASK_APP=app\\api.py
						start flask run
						start java -jar C:\\Users\\josu\\Desktop\\unir\\wiremock-standalone-3.13.2.jar --port 9090 --verbose --root-dir test\\wiremock
						set PYTHONPATH=%WORKSPACE%
						pytest --cov=app --cov-report=xml:coverage-rest.xml --junitxml=result-rest.xml test\\rest
					'''
				}
				junit 'result-rest.xml'
			}
		} 
		stage ('Static'){
            steps{
                bat '''
                    flake8 --exit-zero --format=pylint app >flake8.out
                '''
                recordIssues tools: [flake8(pattern: 'flake8.out')], qualityGates: [[threshold: 8.0, type: 'TOTAL', unstable: true], [threshold: 10.0, type: 'TOTAL', unstable: false]]
            }
        }
		
		stage('Test') {
            steps {
                bat 'dir'
            }
        }
     }
}
