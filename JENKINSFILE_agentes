pipeline {
	agent none
	options { skipDefaultCheckout() }
	
	stages {
		
		stage('Get Code') {
			agent {label 'windows'}
            steps {
				bat 'whoami'
				bat 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
                git 'https://github.com/josuandiamunoz/CP1.git'
				stash name:'code', includes:'**'
            }
        }
		
		stage('Tests') {
			parallel {
				stage('Unit') {
					agent {label 'windows'}
					steps {
						bat 'whoami'
						bat 'hostname'
						echo WORKSPACE
						echo "NODE_NAME = ${env.NODE_NAME}"
						catchError(buildResult: 'UNSTABLE', stageResult: 'SUCCESS') {
							unstash name:'code'
							bat '''
								set PYTHONPATH=%WORKSPACE%
								coverage run --branch --source=app --omit=app\\__init__.py,app\\api.py -m pytest --junitxml=result-unit.xml test\\unit
								coverage xml -o coverage.xml

							'''
							stash name:'coverage', includes:'coverage.xml'
						}
						junit 'result-unit.xml'
					}
				}
				stage('Rest') {
					agent {label 'ubuntu1'}
					steps {
						sh 'whoami'
						sh 'hostname'
						echo WORKSPACE
						echo "NODE_NAME = ${env.NODE_NAME}"
						catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
							unstash name:'code'
							sh '''
								export FLASK_APP=app/api.py
								flask run &
								sleep 4
								java -jar /home/jenkins/Descargas/wiremock-standalone-3.13.2.jar --port 9090 --verbose --root-dir test/wiremock &
								sleep 15
								export PYTHONPATH=${WORKSPACE}
								pytest --junitxml=result-rest.xml test/rest
							'''
						}
						junit 'result-rest.xml'
					}
				}
				stage ('Static'){
					agent {label 'ubuntu2'}
					steps{
						sh 'whoami'
						sh 'hostname'
						echo WORKSPACE
						echo "NODE_NAME = ${env.NODE_NAME}"
						unstash name:'code'
						sh '''
							flake8 --exit-zero --format=pylint app >flake8.out
						'''
						recordIssues tools: [flake8(pattern: 'flake8.out')], qualityGates: [[threshold: 8.0, type: 'TOTAL', unstable: true], [threshold: 10.0, type: 'TOTAL', unstable: false]]
					}
				}
				
				stage('Security') {
					agent {label 'ubuntu2'}
					steps {
						sh 'whoami'
						sh 'hostname'
						echo WORKSPACE
						echo "NODE_NAME = ${env.NODE_NAME}"
						unstash name:'code'
						sh '''
							bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"
						'''
						recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [[threshold: 2.0, type: 'TOTAL', unstable: true], [threshold: 4.0, type: 'TOTAL', unstable: false]]
					}
				}
				
				stage('Performance') {
					agent {label 'windows'}
					steps {
						bat 'whoami'
						bat 'hostname'
						echo WORKSPACE
						echo "NODE_NAME = ${env.NODE_NAME}"
						unstash name:'code'
						bat '''
							set FLASK_APP=app\\api.py
							start flask run
							C:\\Users\\josu\\Desktop\\unir\\jmeter\\apache-jmeter-5.6.3\\bin\\jmeter -n -t "C:\\Users\\josu\\Desktop\\unir\\jmeter\\apache-jmeter-5.6.3\\bin\\Test_Rendimiento.jmx" -f -l flask.jtl
						'''
						perfReport sourceDataFiles: 'flask.jtl'
					}
				}
			}
		}
		
		stage ('Coverage') {
			agent {label 'windows'}
			steps {
				bat 'whoami'
				bat 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
				unstash name:'coverage'
				recordCoverage qualityGates: [[criticality: 'NOTE', integerThreshold: 95, metric: 'LINE', threshold: 95.0], [criticality: 'ERROR', integerThreshold: 85, metric: 'LINE', threshold: 85.0], [criticality: 'NOTE', integerThreshold: 90, metric: 'BRANCH', threshold: 90.0],[criticality: 'ERROR', integerThreshold: 80, metric: 'BRANCH', threshold: 80.0]], tools: [[parser: 'COBERTURA', pattern: 'coverage.xml']]
			}
		}
	
	}
	
}